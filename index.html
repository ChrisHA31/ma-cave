<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ma Cave - Sommelier IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'wine-dark': '#121212',
                        'wine-card': '#1E1E1E',
                        'wine-gold': '#D4AF37',
                        'wine-red': '#800020',
                        'wine-text': '#E0E0E0',
                    }
                }
            }
        }
    </script>
    
    <style>
        input, select, textarea { font-size: 16px !important; }
        .wine-card { transition: transform 0.2s; }
        .wine-card:active { transform: scale(0.98); }
        .loader { border: 3px solid #333; border-top: 3px solid #D4AF37; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .edit-input { background: #2A2A2A; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; width: 100%; margin-bottom: 10px; }
        .edit-input:focus { border-color: #D4AF37; outline: none; }
        
        /* Masquer la scrollbar tout en gardant le scroll */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-wine-dark text-wine-text font-sans min-h-screen pb-24">

    <div id="toast" class="fixed bottom-24 left-1/2 transform -translate-x-1/2 bg-wine-gold text-black px-6 py-3 rounded-full shadow-2xl z-[60] font-bold text-sm hidden transition-opacity duration-300 opacity-0 flex items-center gap-2">
        <span class="animate-spin">‚è≥</span> <span id="toast-message">Message</span>
    </div>

    <nav class="border-b border-gray-800 p-4 sticky top-0 bg-wine-dark/95 backdrop-blur-md z-40 shadow-md">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="font-serif text-2xl text-wine-gold italic tracking-wider">Mon Sommelier</h1>
            
            <div class="flex w-full md:w-1/3 gap-2">
                <input type="text" id="barre-recherche" oninput="filtrerParRecherche()" 
                       placeholder="Rechercher un vin..." 
                       class="bg-gray-900 border border-gray-700 rounded-full py-3 px-5 text-sm w-full focus:border-wine-gold text-white outline-none transition">
                <button onclick="lancerAccordMetsVins()" class="bg-gray-800 border border-gray-700 rounded-full w-12 flex-shrink-0 flex items-center justify-center text-xl hover:bg-wine-gold hover:text-black transition" title="Trouver un accord mets/vins">
                    üçΩÔ∏è
                </button>
            </div>
        </div>
    </nav>

    <header class="max-w-7xl mx-auto p-4 md:p-6">
        <div class="flex overflow-x-auto gap-3 pb-4 mb-6 md:grid md:grid-cols-5 md:overflow-visible scrollbar-hide">
            <div onclick="filtrerVins('all')" class="min-w-[100px] flex-1 bg-wine-card p-3 rounded-xl text-center border border-gray-800 active:border-wine-gold transition">
                <p class="text-[9px] uppercase text-gray-500 mb-1">Total</p>
                <p id="stat-total" class="text-xl font-serif text-white font-bold">0</p>
            </div>
            <div onclick="filtrerVins('Rouge')" class="min-w-[100px] flex-1 bg-wine-card p-3 rounded-xl text-center border-l-4 border-l-wine-red border-y-gray-800 border-r-gray-800 active:border-wine-gold transition">
                <p class="text-[9px] uppercase text-gray-500 mb-1">Rouges</p>
                <p id="stat-rouge" class="text-xl font-serif text-wine-red font-bold">0</p>
            </div>
            <div onclick="filtrerVins('Blanc')" class="min-w-[100px] flex-1 bg-wine-card p-3 rounded-xl text-center border-l-4 border-l-yellow-200 border-y-gray-800 border-r-gray-800 active:border-wine-gold transition">
                <p class="text-[9px] uppercase text-gray-500 mb-1">Blancs</p>
                <p id="stat-blanc" class="text-xl font-serif text-yellow-100 font-bold">0</p>
            </div>
            <div onclick="filtrerVins('Ros√©')" class="min-w-[100px] flex-1 bg-wine-card p-3 rounded-xl text-center border-l-4 border-l-pink-400 border-y-gray-800 border-r-gray-800 active:border-wine-gold transition">
                <p class="text-[9px] uppercase text-gray-500 mb-1">Ros√©s</p>
                <p id="stat-rose" class="text-xl font-serif text-pink-400 font-bold">0</p>
            </div>
            <div class="min-w-[100px] flex-1 bg-wine-card p-3 rounded-xl text-center border-l-4 border-l-wine-gold border-y-gray-800 border-r-gray-800">
                <p class="text-[9px] uppercase text-gray-500 mb-1">Valeur</p>
                <p id="stat-valeur" class="text-xl font-serif text-wine-gold font-bold">0 ‚Ç¨</p>
            </div>
        </div>

        <div class="flex flex-col gap-4 bg-wine-card/50 p-5 rounded-2xl border border-gray-800">
            <div class="flex overflow-x-auto gap-2 pb-2 md:pb-0 scrollbar-hide">
                <button onclick="filtrerVins('all')" class="whitespace-nowrap px-5 py-2 bg-gray-800 rounded-full text-xs uppercase border border-gray-700">Tous</button>
                <button onclick="filtrerVins('Rouge')" class="whitespace-nowrap px-5 py-2 bg-wine-red/20 text-white rounded-full text-xs uppercase border border-wine-red/40">Rouges</button>
                <button onclick="filtrerVins('Blanc')" class="whitespace-nowrap px-5 py-2 bg-yellow-900/20 text-yellow-100 rounded-full text-xs uppercase border border-yellow-900/40">Blancs</button>
                <button onclick="filtrerVins('Ros√©')" class="whitespace-nowrap px-5 py-2 bg-pink-900/20 text-pink-200 rounded-full text-xs uppercase border border-pink-900/40">Ros√©s</button>
            </div>
            
            <div class="flex items-center gap-3 w-full">
                <div class="flex items-center gap-2 bg-gray-900 px-3 py-3 rounded-xl border border-gray-700 shrink-0">
                    <span class="text-xs text-gray-500 italic">Pos.</span>
                    <select id="input-rangee-scan" class="bg-transparent text-wine-gold font-bold focus:outline-none text-base appearance-none cursor-pointer">
                        <option value="1">Rang√©e 1</option>
                        <option value="2">Rang√©e 2</option>
                        <option value="3">Rang√©e 3</option>
                        <option value="4">Rang√©e 4</option>
                        <option value="5">Rang√©e 5</option>
                        <option value="6">Rang√©e 6</option>
                        <option value="7">Rang√©e 7</option>
                        <option value="8">Rang√©e 8</option>
                        <option value="9">‚≠ê Wish List</option>
                    </select>
                </div>
                <button onclick="ouvrirCamera()" class="flex-grow bg-wine-gold text-black font-bold py-3 rounded-xl hover:bg-yellow-500 active:scale-95 transition shadow-lg uppercase tracking-widest text-sm flex justify-center items-center gap-2">
                    <span class="text-lg">üì∏</span> Scanner
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-6 pb-20">
        <div id="grille-vins"></div>
    </main>

    <div id="modal-camera" class="fixed inset-0 bg-black z-50 hidden flex flex-col">
        <div class="relative flex-grow flex items-center justify-center bg-black">
            <video id="video" autoplay playsinline class="absolute inset-0 w-full h-full object-cover"></video>
            <div class="absolute border-2 border-wine-gold/50 w-64 h-80 rounded-2xl pointer-events-none z-10"></div>
            <canvas id="canvas" class="hidden"></canvas>
        </div>
        <div class="bg-wine-card p-8 pb-12 rounded-t-3xl border-t border-gray-800 z-20">
            <div id="actions-camera" class="flex flex-col items-center gap-6">
                <button onclick="fermerCamera()" class="text-gray-400 p-4">Annuler</button>
                <button onclick="prendrePhoto()" class="w-20 h-20 bg-white rounded-full border-4 border-gray-300 shadow-xl active:scale-90 transition"></button>
            </div>
            <div id="loading-state" class="hidden flex flex-col items-center justify-center py-4">
                <div class="loader mb-4"></div>
                <p class="text-wine-gold text-lg animate-pulse font-serif">Envoi de la photo...</p>
            </div>
        </div>
    </div>

    <div id="modal-sommelier" class="fixed inset-0 bg-black/90 hidden flex items-end md:items-center justify-center z-[70]">
        <div class="bg-wine-card border-t md:border border-wine-gold/30 w-full md:max-w-xl md:rounded-3xl rounded-t-3xl p-8 relative h-[80vh] md:h-auto flex flex-col">
            <button onclick="document.getElementById('modal-sommelier').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 text-2xl p-2">‚úï</button>
            <div class="text-center mb-4">
                <div class="text-4xl mb-2">üçΩÔ∏è</div>
                <h3 id="sommelier-titre" class="font-serif text-2xl text-white italic">Le Sommelier</h3>
            </div>
            <div class="overflow-y-auto flex-grow">
                 <div id="sommelier-chargement" class="hidden py-10 text-center">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="text-gray-500 animate-pulse">R√©flexion en cours...</p>
                </div>
                <div id="sommelier-reponse" class="text-gray-300 text-sm leading-7 text-justify pb-10"></div>
            </div>
        </div>
    </div>

    <div id="modal-edition" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[80] p-4">
        <div class="bg-wine-card w-full max-w-lg rounded-2xl border border-gray-700 p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-2">
                <h3 class="font-serif text-xl text-wine-gold italic">Modifier la bouteille</h3>
                <button onclick="fermerEdition()" class="text-gray-400 text-2xl">‚úï</button>
            </div>
            <div class="space-y-3">
                <input type="text" id="edit-nom" class="edit-input" placeholder="Nom">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="edit-annee" class="edit-input" placeholder="Ann√©e">
                    <select id="edit-type" class="edit-input">
                        <option value="Rouge">Rouge</option>
                        <option value="Blanc">Blanc</option>
                        <option value="Ros√©">Ros√©</option>
                    </select>
                </div>
                <input type="text" id="edit-region" class="edit-input" placeholder="R√©gion">
                <input type="text" id="edit-cepage" class="edit-input" placeholder="C√©page">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="edit-prix" class="edit-input" placeholder="Prix">
                    <select id="edit-rangee" class="edit-input border-wine-gold/50 text-wine-gold font-bold">
                        <option value="1">Rang√©e 1</option>
                        <option value="2">Rang√©e 2</option>
                        <option value="3">Rang√©e 3</option>
                        <option value="4">Rang√©e 4</option>
                        <option value="5">Rang√©e 5</option>
                        <option value="6">Rang√©e 6</option>
                        <option value="7">Rang√©e 7</option>
                        <option value="8">Rang√©e 8</option>
                        <option value="9">‚≠ê Wish List</option>
                    </select>
                </div>
            </div>
            <div class="mt-8 flex gap-3">
                <button onclick="fermerEdition()" class="flex-1 py-3 bg-gray-800 rounded-lg text-gray-300">Annuler</button>
                <button onclick="sauvegarderEdition()" class="flex-1 py-3 bg-wine-gold text-black rounded-lg font-bold hover:bg-yellow-500">Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const WEBHOOK_N8N_SCAN = "https://n8n-appart.duckdns.org/webhook/scan-wine";
        const WEBHOOK_N8N_CONSEIL = "https://n8n-appart.duckdns.org/webhook/conseil-sommelier";
        const WEBHOOK_N8N_ACCORD = "https://n8n-appart.duckdns.org/webhook/accord-mets-vins";

        const SUPABASE_URL = "https://yriamevchyqcwszoodpe.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlyaWFtZXZjaHlxY3dzem9vZHBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMTM2NDksImV4cCI6MjA4NDY4OTY0OX0.fi8O2iW7acEm9XBnc2pjZMmX8dKxcrDBiTSiz1z9vNg";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let tousLesVins = [];
        let stream = null;
        let idVinEnEdition = null;

        // --- CORE FUNCTIONS ---
        async function chargerVins() {
            const { data, error } = await supabaseClient.from('bouteilles').select('*').order('created_at', { ascending: false });
            if (data) {
                tousLesVins = data;
                mettreAJourStats(data);
                afficherGrille(data);
            }
        }

        // --- AFFICHAGE EN MODE SWIPE AVEC WISH LIST ---
        function afficherGrille(vinsAafficher, estFiltre = false) {
            const grille = document.getElementById('grille-vins');
            grille.innerHTML = '';
            
            // On ajoute la rang√©e 9 qui correspond √† la Wish List
            const rangeesActives = estFiltre ? [1,2,3,4,5,6,7,8,9] : [1,2,3,4,5,6,7,8,9]; 

            for (let r of rangeesActives) {
                const vinsDeLaRangee = vinsAafficher.filter(v => v.rangee == r);
                
                if (vinsDeLaRangee.length === 0) continue;
                
                const section = document.createElement('div');
                section.className = "mb-6";
                
                // Si c'est 9, on affiche "Wish List" au lieu de "Rang√©e 9"
                const titreRangee = r === 9 ? "‚≠ê Wish List" : `Rang√©e ${r}`;

                const titreHTML = `
                    <div class="sticky top-16 bg-wine-dark/95 z-30 py-2 mb-2 border-b border-gray-800 flex justify-between items-end px-1">
                        <h3 class="font-serif text-lg text-wine-gold italic">${titreRangee}</h3>
                        <span class="text-xs text-gray-500">${vinsDeLaRangee.length} bouteille(s)</span>
                    </div>
                `;

                const carouselHTML = `
                    <div class="flex overflow-x-auto gap-4 pb-4 px-1 snap-x snap-mandatory scrollbar-hide">
                        ${vinsDeLaRangee.map(v => genererCarte(v)).join('')}
                    </div>
                `;

                section.innerHTML = titreHTML + carouselHTML;
                grille.appendChild(section);
            }
            
            if (grille.innerHTML === '') {
                grille.innerHTML = '<div class="text-center text-gray-500 mt-10 italic">Aucun vin trouv√©...</div>';
            }
        }

        function genererCarte(vin) {
            const img = (vin.image_url && vin.image_url.trim() !== "") ? vin.image_url : "https://images.unsplash.com/photo-1559563362-c667ba5f5480?auto=format&fit=crop&q=80&w=800";
            const badge = vin.type_vin === 'Rouge' ? 'bg-wine-red' : (vin.type_vin === 'Blanc' ? 'bg-yellow-100 text-black' : 'bg-pink-400');
            
            return `
            <div id="card-${vin.id}" class="snap-center shrink-0 min-w-[160px] w-[45%] md:w-[200px] bg-wine-card rounded-xl overflow-hidden border border-gray-800 flex flex-col shadow-lg relative h-[280px]">
                <div class="h-40 relative cursor-pointer flex-shrink-0" onclick="ouvrirEdition(${vin.id})">
                    <img src="${img}" class="w-full h-full object-cover opacity-90">
                    <span class="absolute bottom-2 right-2 ${badge} text-[10px] px-2 py-1 rounded-md uppercase font-bold shadow-sm">${vin.type_vin || 'VIN'}</span>
                    <span class="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full text-xs">‚úèÔ∏è</span>
                </div>
                <div class="p-3 flex flex-col flex-grow">
                    <h3 class="font-serif text-sm text-white font-bold leading-tight mb-1 uppercase truncate">${vin.nom || 'Sans Nom'}</h3>
                    <p class="text-wine-gold text-[10px] italic mb-2 truncate">${vin.region || 'Region NC'} ‚Ä¢ ${vin.annee || 'NC'}</p>
                    <div class="mt-auto flex gap-2 pt-2">
                        <button onclick="demanderConseil('${(vin.nom || 'Vin').replace(/'/g, "\\'")}')" class="flex-1 py-2 bg-gray-800 text-wine-gold rounded-lg text-[10px] font-bold border border-gray-700 active:bg-gray-700">Conseil</button>
                        <button onclick="supprimerVin(${vin.id})" class="flex-1 py-2 bg-red-900/20 text-red-400 rounded-lg text-[10px] font-bold border border-red-900/30 active:bg-red-900/40">Bue</button>
                    </div>
                </div>
            </div>`;
        }

        // --- NOTIFICATION TOAST ---
        function afficherToast(message, duree = 3000) {
            const toast = document.getElementById('toast');
            const msgSpan = document.getElementById('toast-message');
            msgSpan.innerText = message;
            
            toast.classList.remove('hidden');
            setTimeout(() => { toast.classList.remove('opacity-0'); }, 10);

            if (duree > 0) {
                setTimeout(() => {
                    toast.classList.add('opacity-0');
                    setTimeout(() => { toast.classList.add('hidden'); }, 300);
                }, duree);
            }
        }

        // --- PHOTO ---
        function prendrePhoto() {
            document.getElementById('actions-camera').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const inputRangee = document.getElementById('input-rangee-scan');
            const valeurRangee = inputRangee.value ? inputRangee.value.toString() : "1";

            canvas.toBlob(blob => {
                const fd = new FormData();
                fd.append('data', blob, 'capture.jpg'); 
                fd.append('rangee', valeurRangee);
                
                fetch(WEBHOOK_N8N_SCAN, { method: 'POST', body: fd })
                .then(res => { 
                    if(res.ok) { 
                        fermerCamera(); 
                        afficherToast("Analyse en cours... Mise √† jour dans 10s", 10000);
                        
                        setTimeout(() => {
                            chargerVins().then(() => {
                                afficherToast("Cave mise √† jour !", 3000);
                            });
                        }, 10000);
                    } 
                })
                .catch(err => {
                    console.error(err);
                    alert("Erreur lors de l'envoi");
                })
                .finally(() => { 
                    document.getElementById('actions-camera').classList.remove('hidden'); 
                    document.getElementById('loading-state').classList.add('hidden');
                });
            }, 'image/jpeg', 0.8);
        }

        // --- ACCORD METS VINS ---
        async function lancerAccordMetsVins() {
            const plat = prompt("Quel plat allez-vous manger ? (ex: Boeuf Bourguignon, Sushi...)");
            if (!plat) return;

            const modale = document.getElementById('modal-sommelier');
            const reponseDiv = document.getElementById('sommelier-reponse');
            const chargement = document.getElementById('sommelier-chargement');
            const titre = document.getElementById('sommelier-titre');
            
            modale.classList.remove('hidden');
            chargement.classList.remove('hidden');
            reponseDiv.innerHTML = "";
            titre.innerText = "Accord pour : " + plat;

            const caveLegere = tousLesVins.map(v => ({
                id: v.id,
                nom: v.nom,
                annee: v.annee,
                type: v.type_vin,
                region: v.region
            }));

            try {
                const res = await fetch(WEBHOOK_N8N_ACCORD, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ plat: plat, vins: caveLegere }) 
                });

                const data = await res.json();
                chargement.classList.add('hidden');
                
                if (data.id) {
                    reponseDiv.innerHTML = `<strong class="text-wine-gold text-lg block mb-2">Je vous recommande :</strong>${data.raison}`;
                    const vinChoisi = tousLesVins.find(v => v.id === data.id);
                    if (vinChoisi) {
                        afficherGrille([vinChoisi], true);
                    }
                } else {
                    reponseDiv.innerText = "Je n'ai pas trouv√© d'accord id√©al dans votre cave.";
                }

            } catch (e) {
                console.error(e);
                chargement.classList.add('hidden');
                reponseDiv.innerText = "Erreur de connexion au Sommelier (N8N).";
            }
        }

        // --- FONCTIONS EXISTANTES ---
        function mettreAJourStats(vins) {
            document.getElementById('stat-total').innerText = vins.length;
            document.getElementById('stat-rouge').innerText = vins.filter(v => v.type_vin === 'Rouge').length;
            document.getElementById('stat-blanc').innerText = vins.filter(v => v.type_vin === 'Blanc').length;
            document.getElementById('stat-rose').innerText = vins.filter(v => v.type_vin === 'Ros√©').length;
            let totalVal = 0;
            vins.forEach(v => { totalVal += v.prix_moyen ? parseInt(v.prix_moyen.match(/\d+/)) || 0 : 0; });
            document.getElementById('stat-valeur').innerText = totalVal + " ‚Ç¨";
        }

        function ouvrirEdition(id) {
            const vin = tousLesVins.find(v => v.id === id);
            if (!vin) return;
            idVinEnEdition = id;
            document.getElementById('edit-nom').value = vin.nom || "";
            document.getElementById('edit-annee').value = vin.annee || "";
            document.getElementById('edit-type').value = vin.type_vin || "Rouge";
            document.getElementById('edit-region').value = vin.region || "";
            document.getElementById('edit-cepage').value = vin.cepage || "";
            document.getElementById('edit-prix').value = vin.prix_moyen || "";
            document.getElementById('edit-rangee').value = vin.rangee || 1;
            document.getElementById('modal-edition').classList.remove('hidden');
        }

        function fermerEdition() {
            document.getElementById('modal-edition').classList.add('hidden');
            idVinEnEdition = null;
        }

        async function sauvegarderEdition() {
            if (!idVinEnEdition) return;
            const inputAnnee = document.getElementById('edit-annee').value;
            const inputRangee = document.getElementById('edit-rangee').value;
            
            const updates = {
                nom: document.getElementById('edit-nom').value,
                annee: inputAnnee ? parseInt(inputAnnee) : null,
                type_vin: document.getElementById('edit-type').value,
                region: document.getElementById('edit-region').value,
                cepage: document.getElementById('edit-cepage').value,
                prix_moyen: document.getElementById('edit-prix').value,
                rangee: inputRangee ? parseInt(inputRangee) : null
            };

            const { error } = await supabaseClient.from('bouteilles').update(updates).eq('id', idVinEnEdition);
            if (error) { alert("Erreur : " + error.message); } 
            else { fermerEdition(); chargerVins(); }
        }

        async function ouvrirCamera() {
            try {
                const streamData = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                stream = streamData;
                document.getElementById('video').srcObject = stream;
                document.getElementById('modal-camera').classList.remove('hidden');
            } catch (e) { alert("Erreur cam√©ra : V√©rifiez les permissions HTTPS"); }
        }

        function fermerCamera() {
            document.getElementById('modal-camera').classList.add('hidden');
            if (stream) stream.getTracks().forEach(t => t.stop());
        }

        async function demanderConseil(nomVin) {
            const modale = document.getElementById('modal-sommelier');
            const reponseDiv = document.getElementById('sommelier-reponse');
            const chargement = document.getElementById('sommelier-chargement');
            document.getElementById('sommelier-titre').innerText = nomVin;
            reponseDiv.innerHTML = ""; modale.classList.remove('hidden'); chargement.classList.remove('hidden');
            try {
                const res = await fetch(WEBHOOK_N8N_CONSEIL, { 
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ nom: nomVin }) 
                });
                const text = await res.text();
                reponseDiv.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-wine-gold">$1</strong>').replace(/\n/g, '<br>');
            } catch (e) { reponseDiv.innerText = "Erreur."; }
            chargement.classList.add('hidden');
        }

        async function supprimerVin(id) {
            if (confirm("Supprimer cette bouteille ?")) { 
                await supabaseClient.from('bouteilles').delete().eq('id', id); 
                chargerVins(); 
            }
        }

        function filtrerVins(c) { afficherGrille(c === 'all' ? tousLesVins : tousLesVins.filter(v => v.type_vin === c), c !== 'all'); }
        function filtrerParRecherche() { 
            const q = document.getElementById('barre-recherche').value.toLowerCase(); 
            afficherGrille(tousLesVins.filter(v => v.nom?.toLowerCase().includes(q) || v.region?.toLowerCase().includes(q)), q !== ""); 
        }

        document.addEventListener('DOMContentLoaded', chargerVins);
    </script>
</body>
</html>
