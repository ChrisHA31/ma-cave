<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ma Cave - Sommelier IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'wine-dark': '#121212',
                        'wine-card': '#1E1E1E',
                        'wine-gold': '#D4AF37',
                        'wine-red': '#800020',
                        'wine-text': '#E0E0E0',
                    }
                }
            }
        }
    </script>
    
    <style>
        input, select, textarea { font-size: 16px !important; }
        .wine-card { transition: transform 0.2s; }
        .wine-card:active { transform: scale(0.98); }
        .loader { border: 3px solid #333; border-top: 3px solid #D4AF37; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Style pour les inputs du formulaire d'√©dition */
        .edit-input { background: #2A2A2A; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; width: 100%; margin-bottom: 10px; }
        .edit-input:focus { border-color: #D4AF37; outline: none; }
        .edit-label { font-size: 12px; color: #D4AF37; margin-bottom: 4px; display: block; text-transform: uppercase; font-weight: bold; }
    </style>
</head>
<body class="bg-wine-dark text-wine-text font-sans min-h-screen pb-10">

    <nav class="border-b border-gray-800 p-4 sticky top-0 bg-wine-dark/95 backdrop-blur-md z-40 shadow-md">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="font-serif text-2xl text-wine-gold italic tracking-wider">Mon Sommelier</h1>
            <input type="text" id="barre-recherche" oninput="filtrerParRecherche()" 
                   placeholder="Rechercher un vin..." 
                   class="bg-gray-900 border border-gray-700 rounded-full py-3 px-5 text-sm w-full md:w-1/3 focus:border-wine-gold text-white outline-none transition">
        </div>
    </nav>

    <header class="max-w-7xl mx-auto p-4 md:p-6">
        <div class="flex overflow-x-auto gap-3 pb-4 mb-6 md:grid md:grid-cols-5 md:overflow-visible scrollbar-hide">
            <div onclick="filtrerVins('all')" class="min-w-[100px] flex-1 bg-wine-card p-3 rounded-xl text-center border border-gray-800 active:border-wine-gold transition">
                <p class="text-[9px] uppercase text-gray-500 mb-1">Total</p>
                <p id="stat-total" class="text-xl font-serif text-white font-bold">0</p>
            </div>
            <div onclick="filtrerVins('Rouge')" class="min-w-[100px] flex-1 bg-wine-card p-3 rounded-xl text-center border-l-4 border-l-wine-red border-y-gray-800 border-r-gray-800 active:border-wine-gold transition">
                <p class="text-[9px] uppercase text-gray-500 mb-1">Rouges</p>
                <p id="stat-rouge" class="text-xl font-serif text-wine-red font-bold">0</p>
            </div>
            <div onclick="filtrerVins('Blanc')" class="min-w-[100px] flex-1 bg-wine-card p-3 rounded-xl text-center border-l-4 border-l-yellow-200 border-y-gray-800 border-r-gray-800 active:border-wine-gold transition">
                <p class="text-[9px] uppercase text-gray-500 mb-1">Blancs</p>
                <p id="stat-blanc" class="text-xl font-serif text-yellow-100 font-bold">0</p>
            </div>
            <div onclick="filtrerVins('Ros√©')" class="min-w-[100px] flex-1 bg-wine-card p-3 rounded-xl text-center border-l-4 border-l-pink-400 border-y-gray-800 border-r-gray-800 active:border-wine-gold transition">
                <p class="text-[9px] uppercase text-gray-500 mb-1">Ros√©s</p>
                <p id="stat-rose" class="text-xl font-serif text-pink-400 font-bold">0</p>
            </div>
            <div class="min-w-[100px] flex-1 bg-wine-card p-3 rounded-xl text-center border-l-4 border-l-wine-gold border-y-gray-800 border-r-gray-800">
                <p class="text-[9px] uppercase text-gray-500 mb-1">Valeur</p>
                <p id="stat-valeur" class="text-xl font-serif text-wine-gold font-bold">0 ‚Ç¨</p>
            </div>
        </div>

        <div class="flex flex-col gap-4 bg-wine-card/50 p-5 rounded-2xl border border-gray-800">
            <div class="flex overflow-x-auto gap-2 pb-2 md:pb-0 scrollbar-hide">
                <button onclick="filtrerVins('all')" class="whitespace-nowrap px-5 py-2 bg-gray-800 rounded-full text-xs uppercase border border-gray-700">Tous</button>
                <button onclick="filtrerVins('Rouge')" class="whitespace-nowrap px-5 py-2 bg-wine-red/20 text-white rounded-full text-xs uppercase border border-wine-red/40">Rouges</button>
                <button onclick="filtrerVins('Blanc')" class="whitespace-nowrap px-5 py-2 bg-yellow-900/20 text-yellow-100 rounded-full text-xs uppercase border border-yellow-900/40">Blancs</button>
                <button onclick="filtrerVins('Ros√©')" class="whitespace-nowrap px-5 py-2 bg-pink-900/20 text-pink-200 rounded-full text-xs uppercase border border-pink-900/40">Ros√©s</button>
            </div>
            
            <div class="flex items-center gap-3 w-full">
                <div class="flex items-center gap-2 bg-gray-900 px-4 py-3 rounded-xl border border-gray-700 shrink-0">
                    <span class="text-xs text-gray-500 italic">Rang√©e</span>
                    <input type="number" id="input-rangee-scan" min="1" max="8" value="1" inputmode="numeric" 
                           class="bg-transparent text-wine-gold font-bold w-6 text-center focus:outline-none text-lg">
                </div>
                <button onclick="ouvrirCamera()" class="flex-grow bg-wine-gold text-black font-bold py-3 rounded-xl hover:bg-yellow-500 active:scale-95 transition shadow-lg uppercase tracking-widest text-sm flex justify-center items-center gap-2">
                    <span class="text-lg">üì∏</span> Scanner
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-6 pb-20">
        <div id="grille-vins"></div>
    </main>

    <div id="modal-camera" class="fixed inset-0 bg-black z-50 hidden flex flex-col">
        <div class="relative flex-grow flex items-center justify-center bg-black">
            <video id="video" autoplay playsinline class="absolute inset-0 w-full h-full object-cover"></video>
            <div class="absolute border-2 border-wine-gold/50 w-64 h-80 rounded-2xl pointer-events-none z-10"></div>
            <canvas id="canvas" class="hidden"></canvas>
        </div>
        <div class="bg-wine-card p-8 pb-12 rounded-t-3xl border-t border-gray-800 z-20">
            <div id="actions-camera" class="flex flex-col items-center gap-6">
                <p class="text-white/80 font-serif italic">Cadrez l'√©tiquette</p>
                <div class="flex justify-between w-full max-w-xs items-center">
                    <button onclick="fermerCamera()" class="text-gray-400 p-4">Annuler</button>
                    <button onclick="prendrePhoto()" class="w-20 h-20 bg-white rounded-full border-4 border-gray-300 shadow-xl active:scale-90 transition"></button>
                    <div class="w-16"></div> 
                </div>
            </div>
            <div id="loading-state" class="hidden flex flex-col items-center justify-center py-4">
                <div class="loader mb-4"></div>
                <p class="text-wine-gold text-lg animate-pulse font-serif">Analyse en cours...</p>
            </div>
        </div>
    </div>

    <div id="modal-sommelier" class="fixed inset-0 bg-black/90 hidden flex items-end md:items-center justify-center z-[70]">
        <div class="bg-wine-card border-t md:border border-wine-gold/30 w-full md:max-w-xl md:rounded-3xl rounded-t-3xl p-8 relative h-[80vh] md:h-auto flex flex-col">
            <button onclick="document.getElementById('modal-sommelier').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 text-2xl p-2">‚úï</button>
            <div class="text-center mb-4">
                <div class="text-4xl mb-2">üç∑</div>
                <h3 id="sommelier-titre" class="font-serif text-2xl text-white italic">Conseils</h3>
            </div>
            <div class="overflow-y-auto flex-grow">
                 <div id="sommelier-chargement" class="hidden py-10 text-center">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="text-gray-500 animate-pulse">R√©daction des conseils...</p>
                </div>
                <div id="sommelier-reponse" class="text-gray-300 text-sm leading-7 text-justify pb-10"></div>
            </div>
        </div>
    </div>

    <div id="modal-edition" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center z-[80] p-4">
        <div class="bg-wine-card w-full max-w-lg rounded-2xl border border-gray-700 p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-2">
                <h3 class="font-serif text-xl text-wine-gold italic">Modifier la bouteille</h3>
                <button onclick="fermerEdition()" class="text-gray-400 text-2xl">‚úï</button>
            </div>

            <div class="space-y-3">
                <div>
                    <label class="edit-label">Nom du vin</label>
                    <input type="text" id="edit-nom" class="edit-input">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="edit-label">Mill√©sime</label>
                        <input type="number" id="edit-annee" class="edit-input">
                    </div>
                    <div>
                        <label class="edit-label">Type</label>
                        <select id="edit-type" class="edit-input">
                            <option value="Rouge">Rouge</option>
                            <option value="Blanc">Blanc</option>
                            <option value="Ros√©">Ros√©</option>
                            <option value="Effervescent">Effervescent</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="edit-label">R√©gion</label>
                    <input type="text" id="edit-region" class="edit-input">
                </div>

                <div>
                    <label class="edit-label">C√©pages</label>
                    <input type="text" id="edit-cepage" class="edit-input">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="edit-label">Prix (‚Ç¨)</label>
                        <input type="text" id="edit-prix" class="edit-input">
                    </div>
                    <div>
                        <label class="edit-label text-wine-gold">Rang√©e</label>
                        <input type="number" id="edit-rangee" class="edit-input border-wine-gold/50 text-wine-gold font-bold">
                    </div>
                </div>
            </div>

            <div class="mt-8 flex gap-3">
                <button onclick="fermerEdition()" class="flex-1 py-3 bg-gray-800 rounded-lg text-gray-300 font-bold text-sm">Annuler</button>
                <button onclick="sauvegarderEdition()" class="flex-1 py-3 bg-wine-gold text-black rounded-lg font-bold text-sm hover:bg-yellow-500 transition">Enregistrer</button>
            </div>
        </div>
    </div>

    <script>
        const WEBHOOK_N8N_URL = "https://n8n-appart.duckdns.org/webhook/scan-wine";
        const SUPABASE_URL = "https://yriamevchyqcwszoodpe.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlyaWFtZXZjaHlxY3dzem9vZHBlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMTM2NDksImV4cCI6MjA4NDY4OTY0OX0.fi8O2iW7acEm9XBnc2pjZMmX8dKxcrDBiTSiz1z9vNg";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let tousLesVins = [];
        let stream = null;
        let idVinEnEdition = null; // Stocke l'ID du vin qu'on modifie

        // --- GESTION DES DONN√âES ---
        async function chargerVins() {
            const { data, error } = await supabaseClient.from('bouteilles').select('*').order('created_at', { ascending: false });
            if (data) {
                tousLesVins = data;
                mettreAJourStats(data);
                afficherGrille(data);
            }
        }

        function mettreAJourStats(vins) {
            document.getElementById('stat-total').innerText = vins.length;
            document.getElementById('stat-rouge').innerText = vins.filter(v => v.type_vin === 'Rouge').length;
            document.getElementById('stat-blanc').innerText = vins.filter(v => v.type_vin === 'Blanc').length;
            document.getElementById('stat-rose').innerText = vins.filter(v => v.type_vin === 'Ros√©').length;
            
            let totalVal = 0;
            vins.forEach(v => {
                const p = v.prix_moyen ? parseInt(v.prix_moyen.match(/\d+/)) : 0;
                totalVal += p;
            });
            document.getElementById('stat-valeur').innerText = totalVal + " ‚Ç¨";
        }

        function afficherGrille(vinsAafficher, estFiltre = false) {
            const grille = document.getElementById('grille-vins');
            grille.innerHTML = '';
            for (let r = 1; r <= 8; r++) {
                const vinsDeLaRangee = vinsAafficher.filter(v => v.rangee == r);
                if (vinsDeLaRangee.length === 0 && estFiltre) continue;
                
                const section = document.createElement('div');
                section.className = "mb-8";
                section.innerHTML = `
                    <h3 class="font-serif text-lg text-wine-gold mb-4 border-b border-gray-800 pb-2 italic sticky top-16 bg-wine-dark/95 py-2 z-30">Rang√©e ${r}</h3>
                    <div class="grid grid-cols-2 gap-4">
                        ${vinsDeLaRangee.map(v => genererCarte(v)).join('')}
                    </div>`;
                grille.appendChild(section);
            }
        }

        function genererCarte(vin) {
            const img = (vin.image_url && vin.image_url.trim() !== "") ? vin.image_url : "https://images.unsplash.com/photo-1559563362-c667ba5f5480?auto=format&fit=crop&q=80&w=800";
            const badge = vin.type_vin === 'Rouge' ? 'bg-wine-red' : (vin.type_vin === 'Blanc' ? 'bg-yellow-100 text-black' : 'bg-pink-400');
            
            // Note: j'ai ajout√© onclick="ouvrirEdition(${vin.id})" sur l'image
            return `
            <div class="wine-card bg-wine-card rounded-xl overflow-hidden border border-gray-800 flex flex-col h-full shadow-lg relative">
                <div class="h-40 relative cursor-pointer" onclick="ouvrirEdition(${vin.id})">
                    <img src="${img}" class="w-full h-full object-cover opacity-90">
                    <div class="absolute inset-0 bg-black/20 hover:bg-black/0 transition"></div>
                    <span class="absolute bottom-2 right-2 ${badge} text-[10px] px-2 py-1 rounded-md uppercase font-bold shadow-sm">${vin.type_vin || 'VIN'}</span>
                    <span class="absolute top-2 right-2 bg-black/50 text-white p-1 rounded-full text-xs">‚úèÔ∏è</span>
                </div>
                <div class="p-3 flex flex-col flex-grow">
                    <h3 class="font-serif text-sm text-white font-bold leading-tight mb-1 uppercase">${vin.nom || 'Sans Nom'}</h3>
                    <p class="text-wine-gold text-[10px] italic mb-2">${vin.region || 'Region NC'} ‚Ä¢ ${vin.annee || 'NC'}</p>
                    
                    <div class="mt-auto flex gap-2 pt-2">
                        <button onclick="demanderConseil('${(vin.nom || 'Vin').replace(/'/g, "\\'")}')" class="flex-1 py-2 bg-gray-800 text-wine-gold rounded-lg text-[10px] font-bold border border-gray-700 active:bg-gray-700">Conseil</button>
                        <button onclick="supprimerVin(${vin.id})" class="flex-1 py-2 bg-red-900/20 text-red-400 rounded-lg text-[10px] font-bold border border-red-900/30 active:bg-red-900/40">Bue</button>
                    </div>
                </div>
            </div>`;
        }

        // --- EDITION MANUELLE ---
        function ouvrirEdition(id) {
            const vin = tousLesVins.find(v => v.id === id);
            if (!vin) return;

            idVinEnEdition = id;
            document.getElementById('edit-nom').value = vin.nom || "";
            document.getElementById('edit-annee').value = vin.annee || "";
            document.getElementById('edit-type').value = vin.type_vin || "Rouge";
            document.getElementById('edit-region').value = vin.region || "";
            document.getElementById('edit-cepage').value = vin.cepage || "";
            document.getElementById('edit-prix').value = vin.prix_moyen || "";
            document.getElementById('edit-rangee').value = vin.rangee || 1;

            document.getElementById('modal-edition').classList.remove('hidden');
        }

        function fermerEdition() {
            document.getElementById('modal-edition').classList.add('hidden');
            idVinEnEdition = null;
        }

        async function sauvegarderEdition() {
            if (!idVinEnEdition) return;

            const updates = {
                nom: document.getElementById('edit-nom').value,
                annee: document.getElementById('edit-annee').value,
                type_vin: document.getElementById('edit-type').value,
                region: document.getElementById('edit-region').value,
                cepage: document.getElementById('edit-cepage').value,
                prix_moyen: document.getElementById('edit-prix').value,
                rangee: document.getElementById('edit-rangee').value
            };

            const { error } = await supabaseClient
                .from('bouteilles')
                .update(updates)
                .eq('id', idVinEnEdition);

            if (error) {
                alert("Erreur lors de la mise √† jour");
                console.error(error);
            } else {
                fermerEdition();
                chargerVins(); // Recharge la grille pour voir les changements
            }
        }

        // --- CAMERA MOBILE ---
        async function ouvrirCamera() {
            try {
                const constraints = { video: { facingMode: "environment" } };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('video');
                video.srcObject = stream;
                document.getElementById('modal-camera').classList.remove('hidden');
            } catch (e) {
                alert("Impossible d'acc√©der √† la cam√©ra.");
                console.error(e);
            }
        }

        function fermerCamera() {
            document.getElementById('modal-camera').classList.add('hidden');
            if (stream) stream.getTracks().forEach(t => t.stop());
        }
        
        function prendrePhoto() {
            document.getElementById('actions-camera').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');

            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const inputRangee = document.getElementById('input-rangee-scan');
            const valeurRangee = inputRangee.value ? inputRangee.value.toString() : "1";

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);

            canvas.toBlob(blob => {
                const fd = new FormData();
                fd.append('data', blob, 'mobile-capture.jpg'); 
                fd.append('rangee', valeurRangee); 

                fetch(WEBHOOK_N8N_URL, { method: 'POST', body: fd })
                .then(res => {
                    if (res.ok) {
                        fermerCamera();
                        setTimeout(chargerVins, 4000); 
                    } else { alert("Erreur serveur N8N."); }
                })
                .catch(e => { alert("Erreur r√©seau"); })
                .finally(() => {
                    document.getElementById('actions-camera').classList.remove('hidden');
                    document.getElementById('loading-state').classList.add('hidden');
                });
            }, 'image/jpeg', 0.8);
        }
        
        // --- SOMMELIER & AUTRES ---
        async function demanderConseil(nomVin) {
            const modale = document.getElementById('modal-sommelier');
            const reponseDiv = document.getElementById('sommelier-reponse');
            const chargement = document.getElementById('sommelier-chargement');
            document.getElementById('sommelier-titre').innerText = nomVin;
            reponseDiv.innerHTML = "";
            modale.classList.remove('hidden');
            chargement.classList.remove('hidden');
            
            try {
                const res = await fetch("https://n8n-appart.duckdns.org/webhook/conseil-sommelier", { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ nom: nomVin }) 
                });
                const text = await res.text();
                reponseDiv.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-wine-gold">$1</strong>').replace(/\n/g, '<br>');
            } catch (e) { reponseDiv.innerText = "Erreur sommelier."; }
            chargement.classList.add('hidden');
        }

        async function supprimerVin(id) {
            if (confirm("Confirmer la suppression ?")) {
                await supabaseClient.from('bouteilles').delete().eq('id', id);
                chargerVins();
            }
        }

        function filtrerVins(c) {
            afficherGrille(c === 'all' ? tousLesVins : tousLesVins.filter(v => v.type_vin === c), c !== 'all');
        }
        
        function filtrerParRecherche() {
             const q = document.getElementById('barre-recherche').value.toLowerCase();
            afficherGrille(tousLesVins.filter(v => v.nom?.toLowerCase().includes(q) || v.region?.toLowerCase().includes(q)), q !== "");
        }

        document.addEventListener('DOMContentLoaded', chargerVins);
    </script>
</body>
</html>